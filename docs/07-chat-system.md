# 7. نظام الدردشة (محاكاة)

يحتوي التطبيق على نظام دردشة يسمح للمستخدمين بإنشاء غرف والانضمام إليها وإرسال الرسائل. من المهم جدًا فهم أن هذا النظام هو **محاكاة** تعمل بالكامل داخل `localStorage` في متصفح واحد، وهو **ليس نظام دردشة حقيقي** يتصل عبر الشبكة.

## المكونات المسؤولة

- **`Chat.tsx`**: الشاشة الرئيسية للدردشة، تعرض قائمة بجميع غرف الدردشة المتاحة.
- **`CreateRoomModal.tsx`**: نافذة منبثقة لإنشاء غرفة دردشة جديدة (عامة أو خاصة).
- **`RoomView.tsx`**: واجهة الدردشة الفعلية داخل غرفة معينة، حيث يتم عرض الرسائل وإرسالها.

## بنية البيانات في `localStorage`

يتم تشغيل نظام الدردشة بالكامل من خلال قطعتين من الحالة يتم تخزينهما عالميًا في `localStorage`:

1.  **`chatRooms`**:
    - **المفتاح في `localStorage`**: `'chatRooms'`
    - **النوع**: `ChatRoom[]` (مصفوفة من كائنات غرف الدردشة).
    - **الوصف**: تحتوي هذه المصفوفة على معلومات حول كل غرفة تم إنشاؤها، مثل اسمها، ونوعها (عامة/خاصة)، وسعر الدخول، وقائمة بمعرفات المستخدمين الأعضاء (`members`).

2.  **`chatMessages`**:
    - **المفتاح في `localStorage`**: `'chatMessages'`
    - **النوع**: `{ [key: string]: ChatMessage[] }` (كائن حيث المفاتيح هي `roomId` والقيم هي مصفوفات من الرسائل).
    - **الوصف**: هذا الكائن يعمل كقاعدة بيانات للرسائل. يتم تجميع كل الرسائل حسب `roomId` الخاص بها. هذا يجعل من السهل جلب جميع رسائل غرفة معينة.

## آلية العمل

### 1. إنشاء غرفة
- عند إنشاء غرفة جديدة عبر `CreateRoomModal.tsx`:
  - يتم إنشاء كائن `ChatRoom` جديد بمعرّف فريد.
  - تتم إضافة `userId` الخاص بمنشئ الغرفة كأول عضو في مصفوفة `members`.
  - يتم إضافة هذا الكائن الجديد إلى مصفوفة `chatRooms` في `localStorage`.

### 2. الانضمام إلى غرفة
- عند النقر على "دخول" في `Chat.tsx`:
  - **التحقق من العضوية**: يتم التحقق مما إذا كان `userId` للمستخدم الحالي موجودًا بالفعل في مصفوفة `members` للغرفة.
  - **الدفع (للغرف الخاصة)**: إذا كانت الغرفة خاصة ولها سعر دخول، يتم خصم التكلفة (نقاط أو جواهر) من رصيد المستخدم.
  - **إضافة العضو**: إذا لم يكن المستخدم عضوًا بالفعل، تتم إضافة `userId` الخاص به إلى مصفوفة `members` للغرفة.
  - **رسالة النظام**: يتم إنشاء رسالة `ChatMessage` من نوع `notification` (مثل "فلان دخل الغرفة") وإضافتها إلى مصفوفة الرسائل الخاصة بهذه الغرفة في `chatMessages`.
  - **الانتقال**: يتم تعيين الغرفة كـ `activeRoom` في حالة `App.tsx`، مما يؤدي إلى عرض `RoomView.tsx`.

### 3. إرسال رسالة
- في `RoomView.tsx`:
  - عند إرسال رسالة، يتم إنشاء كائن `ChatMessage` جديد يحتوي على النص، `roomId`، `senderId`، و `senderName`.
  - تتم إضافة هذا الكائن إلى مصفوفة الرسائل الخاصة بالغرفة الصحيحة داخل كائن `chatMessages` في `localStorage`.
  - بما أن `RoomView` يتلقى قائمة الرسائل كـ `props`، فإن تحديث `chatMessages` في `App.tsx` يؤدي إلى إعادة عرض المكون وظهور الرسالة الجديدة على الفور.

### 4. مغادرة الغرفة
- عند النقر على زر الرجوع في `RoomView.tsx`:
  - يتم إرسال رسالة نظام ("فلان غادر الغرفة").
  - يتم إعادة `activeRoom` في `App.tsx` إلى `null`، مما يعيد المستخدم إلى قائمة الغرف `Chat.tsx`.
  - **ملاحظة**: المستخدم لا يتم إزالته من قائمة `members`، مما يعني أنه يمكنه الدخول مرة أخرى دون دفع الرسوم مرة أخرى.

## القيود
- **محلية بالكامل**: كل هذا يحدث في متصفح واحد. مستخدم على جهاز آخر لن يرى نفس الغرف أو الرسائل.
- **لا يوجد تحديث حي**: إذا فتح مستخدمان التطبيق في علامتي تبويب مختلفتين في نفس المتصفح، فلن يتم تحديث الرسائل تلقائيًا في علامة التبويب الأخرى. يتطلب الأمر إعادة تحميل الصفحة لرؤية التغييرات.
