# 4. تخزين البيانات (Data Persistence)

بما أن هذا التطبيق يعمل بالكامل من جانب العميل (client-side) ولا يتصل بأي خادم، فإننا نعتمد على واجهة برمجة تطبيقات (API) يوفرها المتصفح تسمى **`localStorage`** لتخزين البيانات بشكل دائم.

## ما هو `localStorage`؟

- `localStorage` هو جزء من "Web Storage API" في المتصفحات الحديثة.
- يسمح بتخزين أزواج من المفاتيح والقيم (key-value pairs) على شكل سلاسل نصية (`string`).
- البيانات المخزنة في `localStorage` **تبقى محفوظة** حتى بعد إغلاق المتصفح أو إعادة تشغيل الجهاز. لا يوجد لها تاريخ انتهاء صلاحية.
- كل "أصل" (origin) - أي (protocol + domain + port) - له مساحة تخزين خاصة به.

## كيف نستخدم `localStorage` في المشروع؟

نحن لا نتفاعل مع `localStorage` مباشرة في كل مكون. بدلاً من ذلك، قمنا بتجريد هذه العملية باستخدام الهوك المخصص **`useLocalStorage`**.

- **التجريد (Abstraction)**: الهوك `useLocalStorage` يتعامل مع كل تفاصيل القراءة (`localStorage.getItem`) والكتابة (`localStorage.setItem`) وتحويل البيانات من وإلى JSON (`JSON.parse`, `JSON.stringify`).
- **الاستخدام**: في `App.tsx`، يتم تعريف كل جزء من الحالة التي نريد حفظها باستخدام هذا الهوك.

### بنية مفاتيح التخزين (Storage Keys)

للتفريق بين بيانات المستخدمين المختلفين والبيانات العامة، نتبع نمطًا معينًا في تسمية المفاتيح:

1.  **البيانات الخاصة بالمستخدم (User-Specific Data)**:
    - يتم ربط هذه البيانات بمعرّف المستخدم الفريد (`userId`).
    - **النمط**: `${key}_${currentUser.userId}`
    - **مثال**: إذا كان `userId` هو `12345`، فسيتم تخزين نقاطه تحت مفتاح `points_12345`، وإشعاراته تحت `notifications_12345`.
    - هذا يسمح لعدة مستخدمين باستخدام نفس التطبيق على نفس المتصفح دون تداخل بياناتهم (بعد تسجيل الخروج والدخول بحساب آخر).

2.  **البيانات العامة (Global Data)**:
    - هذه البيانات مشتركة بين جميع المستخدمين.
    - **النمط**: `key`
    - **مثال**:
        - `users`: قائمة جميع المستخدمين المسجلين.
        - `chatRooms`: قائمة جميع غرف الدردشة.
        - `chatMessages`: كائن يحتوي على جميع الرسائل لكل غرفة.

يمكنك فحص هذه البيانات مباشرة في متصفحك عن طريق فتح "أدوات المطور" (Developer Tools)، ثم الانتقال إلى علامة التبويب "Application" (أو "Storage" في Firefox)، واختيار "Local Storage".

## المزايا والعيوب

### المزايا:
- **البساطة**: سهل الاستخدام للغاية ولا يتطلب أي إعداد للخادم.
- **السرعة**: القراءة والكتابة من `localStorage` سريعة جدًا لأنها عملية محلية بالكامل.
- **التشغيل بدون اتصال (Offline Functionality)**: التطبيق يعمل بشكل كامل بدون اتصال بالإنترنت.

### العيوب والقيود:
- **الأمان**: `localStorage` **غير آمن على الإطلاق**. يمكن للمستخدم الوصول إليه وتعديله بسهولة من خلال أدوات المطور في المتصفح. هذا يعني أنه يمكن لأي شخص تعديل نقاطه، أو جواهره، أو أي بيانات أخرى.
- **محدودية السعة**: معظم المتصفحات تحدد حجم `localStorage` بحوالي 5-10 ميغابايت.
- **لا للمشاركة**: البيانات مخزنة **فقط في المتصفح الحالي وعلى الجهاز الحالي**. لا يمكن مشاركتها أو مزامنتها عبر أجهزة مختلفة لنفس المستخدم. ميزات مثل الدردشة هي مجرد محاكاة محلية.
- **البيانات النصية فقط**: يمكن تخزين السلاسل النصية فقط، ولهذا السبب نحتاج إلى `JSON.stringify` لتحويل الكائنات والمصفوفات إلى نص قبل الحفظ، و `JSON.parse` عند القراءة.

**خلاصة**: `localStorage` هو حل ممتاز للنماذج الأولية والتطبيقات البسيطة التي تعمل من جانب العميل، ولكنه غير مناسب أبدًا للتطبيقات الإنتاجية التي تتطلب الأمان ومشاركة البيانات.
