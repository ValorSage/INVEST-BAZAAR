# 6. ميزات اللعبة الأساسية

هذا المستند يغطي المنطق البرمجي وراء الميزات الأساسية التي تشكل تجربة اللعبة. كل هذا المنطق موجود بشكل أساسي في المكون `App.tsx`.

## 1. النقاط والمجوهرات (Points & Jewels)

- **الوصف**: هما العملتان الرئيسيتان في اللعبة.
  - **النقاط**: يمكن جمعها يدويًا في البداية، ثم يتم ربحها يوميًا من العدادات. تُستخدم لشراء العدادات الأساسية وتغيير الاسم/الصورة الشخصية.
  - **المجوهرات**: يتم ربحها يوميًا من العدادات. تُستخدم لشراء العدادات المتقدمة.
- **التنفيذ**:
  - يتم تخزينهما في `localStorage` باستخدام `useLocalStorage` لكل مستخدم على حدة.
  - يتم تحديثهما عبر دوال مثل `setPoints` و `setJewels`.

## 2. نظام العداد (Counter System)

هو الميزة المحورية في اللعبة.

### أ. الشراء الأولي
- **المكونات**: `PointCollector.tsx` و `CounterStore.tsx`.
- **المنطق**:
  1. المستخدمون الجدد ليس لديهم عداد (`hasCounter` تكون `false`).
  2. يرون شاشة `PointCollector` لجمع النقاط بالنقر.
  3. عند الوصول إلى تكلفة العداد (`COUNTER_COST`)، يمكنهم شراء العداد الأول من `CounterStore`.
  4. عند الشراء، يتم خصم النقاط وتعيين `hasCounter` إلى `true`.

### ب. تفعيل العداد والعد التنازلي
- **المكون**: `MainCounter.tsx`.
- **الحالة المسؤولة**: `activationStartTime` (تُخزن في `localStorage`).
- **المنطق**:
  1. عندما ينقر المستخدم على "تفعيل"، يتم تسجيل الوقت الحالي في `activationStartTime`.
  2. طالما أن `activationStartTime` له قيمة، يظهر العد التنازلي.
  3. يتم استخدام الهوك `useCountdown` لحساب الوقت المتبقي بناءً على `activationStartTime + COOLDOWN_PERIOD`.
  4. `COOLDOWN_PERIOD` هي مدة ثابتة (24 ساعة).

### ج. جمع المكافآت
- **المنطق**:
  - في كل مرة يتم فيها إعادة عرض مكون `App.tsx`، يقوم `useEffect` بالتحقق من `activationStartTime`.
  - إذا مر أكثر من 24 ساعة منذ وقت التفعيل (`Date.now() - activationStartTime >= COOLDOWN_PERIOD`):
    1. تتم إضافة المكافآت (`jewelRewardPerCycle` و `pointRewardPerCycle`) إلى رصيد المستخدم.
    2. يتم إرسال إشعار للمستخدم.
    3. يتم إعادة تعيين `activationStartTime` إلى `null`، مما يسمح بتفعيل العداد مرة أخرى.

### د. شراء عدادات إضافية (من المتجر)
- **المكون**: `Store.tsx`.
- **المنطق**:
  1. يعرض المتجر قائمة بالعدادات المتاحة للشراء.
  2. عند الشراء، يتم خصم السعر (نقاط أو جواهر) من رصيد المستخدم.
  3. يتم إضافة العداد الجديد إلى مصفوفة `userCounters` الخاصة بالمستخدم.
  4. المكافأة اليومية الإجمالية (`jewelRewardPerCycle` و `pointRewardPerCycle`) هي مجموع مكافآت **كل** العدادات التي يمتلكها المستخدم. يتم حسابها ديناميكيًا باستخدام `Array.reduce()` على مصفوفة `userCounters`.

## 3. إهداء العدادات (Gifting)

- **المكون**: `GiftCounter.tsx`.
- **المنطق**:
  1. **البحث**: يبحث المُهدي عن مستخدم آخر باستخدام `userId`. يتم البحث في قائمة `allUsers` المخزنة.
  2. **الاختيار والشراء**: يختار المُهدي عدادًا من قائمة الهدايا.
  3. **التحقق من الرصيد**: يتم التحقق مما إذا كان المُهدي يمتلك نقاطًا أو جواهر كافية.
  4. **تنفيذ الهدية (`handleGiftCounter`)**:
     - يتم خصم التكلفة من رصيد المُهدي.
     - **الأهم**: يتم تعديل `localStorage` **مباشرة** للمستلم.
       - يتم جلب عدادات المستلم (`userCounters_<recipientId>`) من `localStorage`.
       - تتم إضافة العداد الجديد إلى القائمة.
       - يتم حفظ القائمة المحدثة مرة أخرى في `localStorage` الخاص بالمستلم.
     - يتم إضافة إشعار إلى قائمة إشعارات المستلم (`notifications_<recipientId>`) في `localStorage`.
     - يتم إضافة إشعار تأكيد إلى قائمة إشعارات المُهدي.

هذا النهج (التعديل المباشر لبيانات مستخدم آخر في `localStorage`) ممكن فقط لأن التطبيق يعمل بالكامل من جانب العميل. في تطبيق حقيقي، سيتم هذا عبر طلب API إلى الخادم.
